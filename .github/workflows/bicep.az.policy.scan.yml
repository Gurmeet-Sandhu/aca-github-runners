name: Bicep Compliance Scan against Azure Policy
on:
  workflow_dispatch

jobs:
  bicep-scan:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Policy Scan
        shell: pwsh
        run: |
          Install-Module -Name Az -Scope CurrentUser - Force -AllowClobber
          Install-Module -Name PSRule.Rules.Azure -Scope CurrentUser -AllowPrerelease - Force -AllowClobber
          Install-Module -Name EnterprisePolicyAsCode -Scope CurrentUser - Force -AllowClobber

          cd ${{github.workspace}}\PSRule
      
          Export-AzPolicyResources -DefinitionsRootFolder .\ -Mode psrule -OutputFolder .\
          Export-AzPolicyAssignmentRuleData -AssignmentFile .\psrule.assignment.json -OutputPath .\ps-rule

          Assert-PSRule -InputPath ..\az-policy-scan\ -Module "PSRule.Rules.Azure" -Format File